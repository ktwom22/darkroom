{% extends "layout.html" %}
{% block content %}

<section class="max-w-7xl mx-auto py-12 px-6">
    {% set pending_zips = sessions|selectattr('selection_submitted', 'equalto', True)|list %}

    <div class="flex flex-col md:flex-row justify-between items-end mb-10 gap-6 border-b-2 border-stone-200 pb-8">
        <div>
            <h1 class="text-5xl font-black tracking-tighter text-black uppercase italic">
                {% if is_queue_view %}Retouching Queue{% else %}Studio Dashboard{% endif %}
            </h1>
            <p class="text-[10px] font-black uppercase tracking-[0.4em] text-stone-400 mt-2">
                {% if is_queue_view %}Focusing on Selections Ready for Export{% else %}Active Intelligence & Archive Control{% endif %}
            </p>
        </div>

        {% if is_queue_view %}
            <a href="{{ url_for('dashboard') }}" class="bg-black text-white px-8 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-stone-800 transition-all shadow-lg">
                ‚Üê View All Projects
            </a>
        {% else %}
            {% if pending_zips %}
            <a href="{{ url_for('retouching_queue') }}" class="flex items-center gap-4 bg-amber-400 p-3 pr-6 rounded-2xl border-2 border-black hover:bg-black hover:text-white transition-all group shadow-md">
                <div class="bg-black group-hover:bg-white group-hover:text-black text-white w-10 h-10 rounded-xl flex items-center justify-center font-black text-lg transition-colors">
                    {{ pending_zips|length }}
                </div>
                <p class="text-[10px] font-black uppercase tracking-widest">Focus Queue ‚Üí</p>
            </a>
            {% endif %}
        {% endif %}
    </div>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
        <div class="bg-white border-2 border-stone-100 p-6 rounded-3xl flex items-center justify-between shadow-sm">
            <div>
                <p class="text-[9px] font-black uppercase tracking-[0.2em] text-stone-400">Total Revenue</p>
                <h2 class="text-2xl font-black text-black tracking-tight">${{ "{:,.2f}".format(total_collected or 0) }}</h2>
            </div>
            <div class="text-stone-100 text-3xl font-black">$$</div>
        </div>

        <div class="bg-white border-2 border-stone-100 p-6 rounded-3xl flex items-center justify-between shadow-sm">
            <div>
                <p class="text-[9px] font-black uppercase tracking-[0.2em] text-stone-400">Unpaid Balances</p>
                <h2 class="text-2xl font-black text-red-600 tracking-tight">${{ "{:,.2f}".format(pending_balance or 0) }}</h2>
            </div>
            <div class="text-red-50 text-3xl font-black">!!</div>
        </div>

        <div class="bg-stone-900 p-6 rounded-3xl flex items-center justify-between shadow-xl">
            <div>
                <p class="text-[9px] font-black uppercase tracking-[0.2em] text-stone-500">Active Archive</p>
                <h2 class="text-2xl font-black text-white tracking-tight">{{ sessions|length }} <span class="text-[10px] text-stone-500 ml-1 italic">Jobs</span></h2>
            </div>
            <div class="text-stone-800 text-3xl font-black">#</div>
        </div>
    </section>

    {% if not is_queue_view %}
    <div class="bg-white p-10 rounded-[2.5rem] border-2 border-stone-100 shadow-sm mb-16">
        <h2 class="text-xl font-black uppercase tracking-tighter mb-6 italic">Launch New Session</h2>
        <form action="/create-session" method="POST" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-stone-400 ml-2">Client Name</label>
                    <input type="text" name="client_name" required class="w-full p-4 rounded-xl bg-stone-50 border-2 border-stone-100 focus:border-black outline-none font-bold text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-red-400 ml-2">Email</label>
                    <input type="email" name="client_email" required class="w-full p-4 rounded-xl bg-stone-50 border-2 border-stone-100 focus:border-black outline-none font-bold text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-stone-400 ml-2">Location</label>
                    <input type="text" name="location" class="w-full p-4 rounded-xl bg-stone-50 border-2 border-stone-100 focus:border-black outline-none font-bold text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-stone-400 ml-2">Type</label>
                    <select name="session_type" class="w-full p-4 rounded-xl bg-stone-100 border-2 border-stone-100 font-black text-[10px] uppercase tracking-widest appearance-none h-[54px]">
                        <option>Wedding</option>
                        <option>Portrait</option>
                        <option>Editorial</option>
                        <option>Commercial</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-stone-400 ml-2">Date</label>
                    <input type="date" name="date" class="w-full p-4 rounded-xl bg-stone-50 border-2 border-stone-100 font-bold text-sm">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black uppercase text-stone-400 ml-2">Fee ($)</label>
                    <input type="number" step="0.01" name="total_fee" placeholder="0.00" class="w-full p-4 rounded-xl bg-stone-50 border-2 border-stone-100 focus:border-black outline-none font-bold text-sm">
                </div>
                <div class="flex items-end">
                    <button type="submit" class="w-full bg-black text-white h-[54px] rounded-xl font-black text-[10px] uppercase tracking-[0.2em] hover:bg-stone-800 transition-all">Initialize Archive +</button>
                </div>
            </div>
        </form>
    </div>
    {% endif %}

    <div class="flex flex-col md:flex-row justify-between items-end mb-10 px-4 gap-6">
        <h2 class="text-3xl font-black tracking-tighter uppercase italic text-stone-900">
            {% if is_queue_view %}Ready for Export{% else %}Active Projects{% endif %}
        </h2>
        <input type="text" id="projectSearch" onkeyup="filterProjects()" placeholder="Search archives..." class="bg-white border-2 border-stone-100 rounded-full py-4 px-8 text-sm focus:border-black w-full md:w-80 font-bold outline-none shadow-sm">
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10" id="projectGrid">
        {% for session in sessions %}
        <div class="project-card bg-white rounded-[3.5rem] overflow-hidden border-2 border-stone-50 shadow-xl group transition-transform hover:scale-[1.02]">

            <div class="h-64 relative overflow-hidden bg-stone-900">
                {% if session.photos %}
                    <img src="{{ url_for('display_image', filename=session.photos[0].filename) }}" class="w-full h-full object-cover">
                {% else %}
                    {% if session.session_type == 'Wedding' %}
                        <img src="https://images.unsplash.com/photo-1511795409834-ef04bbd61622?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover opacity-90">
                    {% elif session.session_type == 'Portrait' %}
                        <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover opacity-90">
                    {% elif session.session_type == 'Editorial' %}
                        <img src="https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover opacity-90">
                    {% else %}
                        <img src="https://images.unsplash.com/photo-1497366754035-f200968a6e72?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover opacity-90">
                    {% endif %}
                {% endif %}

                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/10 to-transparent"></div>
                <div class="absolute bottom-6 left-8 text-white">
                    <p class="text-[8px] font-black uppercase tracking-[0.3em] text-stone-400 mb-1">{{ session.session_type }}</p>
                    <h4 class="text-2xl font-black tracking-tighter client-name-text">{{ session.client_name }}</h4>
                </div>
            </div>

            {% if session.selection_submitted %}
            <div class="bg-amber-400 p-6 border-b-2 border-black">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[9px] font-black uppercase tracking-widest text-black">Selections Ready</span>
                    {% set zip_name = "Selections_" ~ session.client_name.replace(' ', '_') ~ "_" ~ session.id ~ ".zip" %}
                    <a href="{{ url_for('static', filename='exports/' ~ zip_name) }}" download class="text-[9px] font-black bg-black text-white px-4 py-2 rounded-lg">ZIP ‚Üì</a>
                </div>
                <a href="{{ url_for('complete_job', id=session.id) }}" class="block text-center bg-white text-black py-3 rounded-xl text-[9px] font-black uppercase border-2 border-black hover:bg-black hover:text-white transition-all">Finish Project</a>
            </div>
            {% endif %}

            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <p class="text-[8px] font-black uppercase text-stone-400 tracking-widest mb-1">Location</p>
                        <p class="text-xs font-bold italic text-stone-900">üìç {{ session.location or "Studio" }}</p>
                    </div>
                    {% set balance = (session.total_fee or 0) - (session.amount_paid or 0) %}
                    <div class="text-right">
                        <p class="text-[8px] font-black uppercase text-stone-400 tracking-widest mb-1">Balance</p>
                        <span class="text-lg font-black {% if balance > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                            {{ "$" ~ "{:,.2f}".format(balance) if balance > 0 else "PAID" }}
                        </span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <a href="{{ url_for('portal', id=session.id) }}" class="text-center bg-black text-white py-4 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-stone-800 transition-all shadow-lg">Portal</a>
                    <a href="{{ url_for('client_manager') }}" class="text-center bg-stone-100 text-stone-800 py-4 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-stone-200 transition-all">Edit</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<script>
function filterProjects() {
    let input = document.getElementById('projectSearch').value.toLowerCase();
    let cards = document.querySelectorAll('.project-card');
    cards.forEach(card => {
        let name = card.querySelector('.client-name-text').innerText.toLowerCase();
        card.style.display = name.includes(input) ? "block" : "none";
    });
}
</script>

{% endblock %}